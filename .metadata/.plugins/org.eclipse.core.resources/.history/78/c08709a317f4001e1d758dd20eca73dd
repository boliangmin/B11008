/******************************************************************************************************************************************************************
* 文件名称: framework_aht10.c
* 文件描述: AHT10相关封装函数
* 维护人员: bo.liangmin
* 版本信息: 20240406--代码创建
******************************************************************************************************************************************************************/



/************************************************************************************************************************************************
* include
************************************************************************************************************************************************/
#include "../../FrameWork/FrameWork_AHT10/framework_aht10.h"

#include <stdio.h>
#include "hal_i2c.h"
#include "esp_log.h"
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>



/******************************************************************************************************************************************************************
* define
******************************************************************************************************************************************************************/
static aht10_data_t framework_aht10_data = { 0.0, 0.0 };
static const char *AHTTAG = "AHT10";



/******************************************************************************************************************************
* 函数名称: void FrameWork_AHT10_DeviceInit(void)
* 函数说明: AHT10设备初始化
* 输入参数: 无
* 输出参数: 无
* 返回数值: 无
******************************************************************************************************************************/
void FrameWork_AHT10_DeviceInit(void)
{
    uint8_t init_command[3] = { 0xe1, 0x08, 0x00 };

    HAL_I2C_WriteCommand(AHT10_DEVICEADDR, init_command);
}

/******************************************************************************************************************************
* 函数名称: void FrameWork_AHT10_ReadData(void)
* 函数说明: AHT10读取温湿度
* 输入参数: 无
* 输出参数: 无
* 返回数值: 无
******************************************************************************************************************************/
void FrameWork_AHT10_ReadData(void)
{
    uint32_t temp_temp = 0x0;
    uint32_t temp_humi = 0x0;
    uint8_t data_buffer[6]  = { 0 };
    uint8_t read_command[3] = { 0xac, 0x33, 0x00 };

    HAL_I2C_WriteCommand(AHT10_DEVICEADDR, read_command);
    vTaskDelay(80);
    HAL_I2C_ReadData(AHT10_DEVICEADDR, data_buffer, 6);

    if((data_buffer[0] & 0x08) == 0x08)
    {
        temp_humi = ( data_buffer[1] << 12) | (data_buffer[2] << 4) | (data_buffer[3] >> 4);
        temp_temp = ((data_buffer[3] &  0x0f) << 16) | (data_buffer[4] << 8) | (data_buffer[5]);

        framework_aht10_data.humidity    = (temp_humi * 100.0  / 1024 / 1024 + 0.5);
        framework_aht10_data.temperature = (temp_temp * 2000.0 / 1024 / 1024 + 0.5) / 10.0 - 50;

        ESP_LOGI(AHTTAG, "humi:%.2f temp:%.2f", framework_aht10_data.humidity, framework_aht10_data.temperature);
    }
}



/******************************************************************************************************************************************************************
* end
******************************************************************************************************************************************************************/


